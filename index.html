
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>日本旅記帳</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fdf2f8">
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fdf2f8; /* Pink-50 */
            -webkit-tap-highlight-color: transparent;
        }
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 靜態資料與 Helper ---
        const CATEGORIES = [
            { id: 'food', name: '餐飲', icon: 'utensils', color: 'bg-orange-100 text-orange-600' },
            { id: 'transport', name: '交通', icon: 'train', color: 'bg-blue-100 text-blue-600' },
            { id: 'shopping', name: '購物', icon: 'shopping-bag', color: 'bg-pink-100 text-pink-600' },
            { id: 'ticket', name: '門票', icon: 'ticket', color: 'bg-purple-100 text-purple-600' },
            { id: 'hotel', name: '住宿', icon: 'bed', color: 'bg-indigo-100 text-indigo-600' },
            { id: 'other', name: '其他', icon: 'more-horizontal', color: 'bg-gray-100 text-gray-600' },
        ];

        const formatJPY = (val) => new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY', maximumFractionDigits: 0 }).format(val);
        const formatTWD = (val) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val);

        // --- 子元件 (移出 App 外部以修復 focus 問題) ---

        const AddTab = ({ 
            amount, setAmount, 
            note, setNote, 
            selectedCategory, setSelectedCategory, 
            date, setDate, 
            exchangeRate, 
            onAdd 
        }) => {
            return (
                <div className="flex flex-col h-full p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl shadow-sm p-6 mb-6 text-center border border-pink-100">
                        <div className="text-gray-500 text-sm mb-1">今日匯率: {exchangeRate}</div>
                        <input 
                            type="number" 
                            inputMode="decimal"
                            value={amount}
                            onChange={(e) => setAmount(e.target.value)}
                            placeholder="¥ 0"
                            className="w-full text-center text-4xl font-bold text-gray-800 placeholder-gray-200 outline-none mb-2"
                            // 移除 autoFocus 以避免手機鍵盤亂跳
                        />
                        <div className="text-pink-500 font-medium text-lg">
                            ≈ {formatTWD(amount * exchangeRate || 0)}
                        </div>
                    </div>

                    <div className="grid grid-cols-3 gap-3 mb-6">
                        {CATEGORIES.map(cat => (
                            <button
                                key={cat.id}
                                onClick={() => setSelectedCategory(cat.id)}
                                className={`flex flex-col items-center justify-center p-3 rounded-xl transition-all ${
                                    selectedCategory === cat.id 
                                    ? `${cat.color} ring-2 ring-offset-1 ring-pink-300 shadow-md` 
                                    : 'bg-white text-gray-400 hover:bg-gray-50'
                                }`}
                            >
                                <i data-lucide={cat.icon} className="mb-1"></i>
                                <span className="text-xs font-medium">{cat.name}</span>
                            </button>
                        ))}
                    </div>

                    <div className="space-y-4 mb-20">
                        <div className="bg-white rounded-xl p-3 shadow-sm border border-gray-100 flex items-center">
                            <i data-lucide="calendar" className="text-gray-400 w-5 h-5 ml-2 mr-3"></i>
                            <input 
                                type="date" 
                                value={date}
                                onChange={(e) => setDate(e.target.value)}
                                className="w-full outline-none text-gray-700 bg-transparent"
                            />
                        </div>
                        <div className="bg-white rounded-xl p-3 shadow-sm border border-gray-100 flex items-center">
                            <i data-lucide="pen-line" className="text-gray-400 w-5 h-5 ml-2 mr-3"></i>
                            <input 
                                type="text" 
                                value={note}
                                onChange={(e) => setNote(e.target.value)}
                                placeholder="備註 (例如: 全家炸雞)"
                                className="w-full outline-none text-gray-700 bg-transparent"
                            />
                        </div>
                        
                        <button 
                            onClick={onAdd}
                            className="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-pink-200 active:scale-95 transition-transform flex items-center justify-center gap-2"
                        >
                            <i data-lucide="plus-circle"></i>
                            記一筆
                        </button>
                    </div>
                </div>
            );
        };

        const ListTab = ({ transactions, totalSpent, exchangeRate, onDelete }) => {
            // Group by date
            const grouped = useMemo(() => {
                const groups = {};
                transactions.forEach(t => {
                    if (!groups[t.date]) groups[t.date] = [];
                    groups[t.date].push(t);
                });
                return Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0]));
            }, [transactions]);

            return (
                <div className="p-4 pb-24">
                    <div className="flex justify-between items-end mb-6 px-2">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">消費明細</h2>
                            <p className="text-gray-500 text-sm">{transactions.length} 筆紀錄</p>
                        </div>
                        <div className="text-right">
                            <div className="text-xs text-gray-500">總支出</div>
                            <div className="text-xl font-bold text-pink-600">{formatJPY(totalSpent)}</div>
                            <div className="text-xs text-gray-400">≈ {formatTWD(totalSpent * exchangeRate)}</div>
                        </div>
                    </div>

                    {transactions.length === 0 ? (
                        <div className="text-center text-gray-400 mt-20">
                            <i data-lucide="japanese-yen" className="w-16 h-16 mx-auto mb-4 opacity-20"></i>
                            <p>還沒有紀錄喔</p>
                        </div>
                    ) : (
                        grouped.map(([dateStr, items]) => (
                            <div key={dateStr} className="mb-6 animate-fade-in-up">
                                <h3 className="text-sm font-bold text-gray-400 mb-2 ml-1 sticky top-0 bg-[#fdf2f8]/90 backdrop-blur-sm py-1 z-10">
                                    {dateStr === new Date().toISOString().split('T')[0] ? '今天' : dateStr}
                                </h3>
                                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                    {items.map((t, idx) => {
                                        const cat = CATEGORIES.find(c => c.id === t.category) || CATEGORIES[5];
                                        return (
                                            <div key={t.id} className={`flex items-center p-4 ${idx !== items.length -1 ? 'border-b border-gray-50' : ''}`}>
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${cat.color} bg-opacity-20 mr-4 shrink-0`}>
                                                    <i data-lucide={cat.icon} className="w-5 h-5"></i>
                                                </div>
                                                <div className="flex-1 min-w-0 mr-2">
                                                    <div className="font-medium text-gray-800 truncate">{t.note}</div>
                                                    <div className="text-xs text-gray-400">{cat.name}</div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="font-bold text-gray-800">{formatJPY(t.amount)}</div>
                                                    <div className="text-xs text-gray-400">≈ {formatTWD(t.amount * exchangeRate)}</div>
                                                </div>
                                                <button 
                                                    onClick={() => onDelete(t.id)}
                                                    className="ml-3 p-2 text-gray-300 hover:text-red-500 transition-colors"
                                                >
                                                    <i data-lucide="trash-2" className="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ))
                    )}
                </div>
            );
        };

        const SettingsTab = ({ 
            transactions, setTransactions, 
            exchangeRate, setExchangeRate,
            totalSpent
        }) => {
             const stats = useMemo(() => {
                const res = {};
                transactions.forEach(t => {
                    if(!res[t.category]) res[t.category] = 0;
                    res[t.category] += t.amount;
                });
                return Object.entries(res).sort((a,b) => b[1] - a[1]);
            }, [transactions]);

            const handleExport = () => {
                const dataStr = JSON.stringify(transactions);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `japan_ledger_backup_${new Date().toISOString().slice(0,10)}.json`;
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };

            const handleImport = (event) => {
                const fileObj = event.target.files[0];
                if (!fileObj) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (Array.isArray(json)) {
                            if(confirm(`確定要匯入 ${json.length} 筆資料嗎？`)){
                                const currentIds = new Set(transactions.map(t => t.id));
                                const newTransactions = json.filter(t => !currentIds.has(t.id));
                                setTransactions([...transactions, ...newTransactions].sort((a,b) => b.id - a.id));
                                alert('匯入成功！');
                            }
                        } else { alert('檔案格式錯誤'); }
                    } catch (err) { alert('讀取失敗：' + err); }
                };
                reader.readAsText(fileObj);
            };

            return (
                <div className="p-4 pb-24">
                     <h2 className="text-2xl font-bold text-gray-800 mb-6 px-2">統計與設定</h2>
                     
                     <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-6">
                        <h3 className="font-bold text-gray-700 mb-4">消費分類佔比</h3>
                        {stats.length === 0 ? <p className="text-gray-400 text-sm">無資料</p> : (
                            <div className="space-y-3">
                                {stats.map(([catId, amount]) => {
                                    const cat = CATEGORIES.find(c => c.id === catId) || CATEGORIES[5];
                                    const percent = totalSpent > 0 ? Math.round((amount / totalSpent) * 100) : 0;
                                    return (
                                        <div key={catId}>
                                            <div className="flex justify-between text-sm mb-1">
                                                <span className="flex items-center gap-2">
                                                    <i data-lucide={cat.icon} className="w-3 h-3 text-gray-400"></i>
                                                    {cat.name}
                                                </span>
                                                <span className="font-medium">{formatJPY(amount)} ({percent}%)</span>
                                            </div>
                                            <div className="w-full bg-gray-100 rounded-full h-2">
                                                <div 
                                                    className={`h-2 rounded-full ${cat.color.split(' ')[0].replace('text', 'bg').replace('100', '400')}`} 
                                                    style={{width: `${percent}%`}}
                                                ></div>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                     </div>

                     <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 space-y-6">
                        <div>
                            <label className="block text-sm font-medium text-gray-600 mb-2">
                                匯率設定 (1 JPY = ? TWD)
                            </label>
                            <div className="flex items-center gap-2">
                                <input 
                                    type="number" 
                                    step="0.001"
                                    value={exchangeRate} 
                                    onChange={(e) => setExchangeRate(e.target.value)}
                                    className="w-full border border-gray-200 rounded-lg p-2 outline-none focus:border-pink-300"
                                />
                                <span className="text-gray-500 text-sm whitespace-nowrap">台幣</span>
                            </div>
                        </div>

                        <div className="pt-4 border-t border-gray-50">
                            <h4 className="font-medium text-gray-700 mb-3">資料備份</h4>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={handleExport} className="flex items-center justify-center gap-2 py-2 px-4 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm">
                                    <i data-lucide="download" className="w-4 h-4"></i> 匯出
                                </button>
                                <label className="flex items-center justify-center gap-2 py-2 px-4 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 text-sm cursor-pointer">
                                    <i data-lucide="upload" className="w-4 h-4"></i> 匯入
                                    <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                                </label>
                            </div>
                        </div>
                        
                        <div className="pt-4 border-t border-gray-50">
                            <button 
                                onClick={() => { if(confirm('確定要清空所有資料嗎？')) { setTransactions([]); alert('已清空'); }}}
                                className="w-full text-red-400 text-sm hover:text-red-600 py-2"
                            >
                                清空所有資料
                            </button>
                        </div>
                     </div>
                </div>
            );
        };

        // --- 主元件 ---
        const App = () => {
            const [transactions, setTransactions] = useState([]);
            const [exchangeRate, setExchangeRate] = useState(0.22);
            const [activeTab, setActiveTab] = useState('add');
            
            // Form State (提升到 App 層，避免切換 Tab 時資料消失)
            const [amount, setAmount] = useState('');
            const [note, setNote] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('food');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);

            useEffect(() => {
                const savedData = localStorage.getItem('japan_travel_ledger');
                const savedRate = localStorage.getItem('japan_travel_rate');
                if (savedData) setTransactions(JSON.parse(savedData));
                if (savedRate) setExchangeRate(parseFloat(savedRate));
                if (window.lucide) window.lucide.createIcons();
            }, []);

            useEffect(() => {
                localStorage.setItem('japan_travel_ledger', JSON.stringify(transactions));
            }, [transactions]);

            useEffect(() => {
                localStorage.setItem('japan_travel_rate', exchangeRate);
            }, [exchangeRate]);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            const totalSpent = useMemo(() => transactions.reduce((sum, t) => sum + Number(t.amount), 0), [transactions]);

            const handleAddTransaction = (e) => {
                e.preventDefault();
                if (!amount) return;

                const newTransaction = {
                    id: Date.now(),
                    amount: Number(amount),
                    category: selectedCategory,
                    note: note || CATEGORIES.find(c => c.id === selectedCategory).name,
                    date: date,
                    timestamp: new Date().toISOString()
                };

                setTransactions([newTransaction, ...transactions]);
                setAmount('');
                setNote('');
                alert('已記錄！');
            };

            const handleDelete = (id) => {
                if (confirm('確定要刪除這筆紀錄嗎？')) {
                    setTransactions(transactions.filter(t => t.id !== id));
                }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#fdf2f8] relative shadow-2xl">
                    <header className="bg-white/80 backdrop-blur-md sticky top-0 z-20 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                        <div className="flex items-center gap-2 text-pink-600 font-bold text-lg">
                            <i data-lucide="plane" className="w-5 h-5"></i>
                            日本旅記
                        </div>
                        <div className="text-xs font-mono text-gray-400 bg-gray-50 px-2 py-1 rounded">
                            ¥1 ≈ NT${exchangeRate}
                        </div>
                    </header>

                    <main>
                        {activeTab === 'add' && (
                            <AddTab 
                                amount={amount} setAmount={setAmount}
                                note={note} setNote={setNote}
                                selectedCategory={selectedCategory} setSelectedCategory={setSelectedCategory}
                                date={date} setDate={setDate}
                                exchangeRate={exchangeRate}
                                onAdd={handleAddTransaction}
                            />
                        )}
                        {activeTab === 'list' && (
                            <ListTab 
                                transactions={transactions} 
                                totalSpent={totalSpent} 
                                exchangeRate={exchangeRate}
                                onDelete={handleDelete}
                            />
                        )}
                        {activeTab === 'settings' && (
                            <SettingsTab 
                                transactions={transactions} setTransactions={setTransactions}
                                exchangeRate={exchangeRate} setExchangeRate={setExchangeRate}
                                totalSpent={totalSpent}
                            />
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-100 px-6 py-3 flex justify-between items-center z-20 pb-safe">
                        <button 
                            onClick={() => setActiveTab('list')}
                            className={`flex flex-col items-center gap-1 ${activeTab === 'list' ? 'text-pink-600' : 'text-gray-400'}`}
                        >
                            <i data-lucide="list" className="w-6 h-6"></i>
                            <span className="text-[10px]">明細</span>
                        </button>
                        
                        <div className="relative -top-5">
                            <button 
                                onClick={() => setActiveTab('add')}
                                className={`w-12 h-12 rounded-full flex items-center justify-center shadow-lg shadow-pink-200 transition-transform ${activeTab === 'add' ? 'bg-pink-600 text-white scale-110' : 'bg-white text-pink-500 border border-pink-100'}`}
                            >
                                <i data-lucide="plus" className="w-6 h-6"></i>
                            </button>
                        </div>

                        <button 
                            onClick={() => setActiveTab('settings')}
                            className={`flex flex-col items-center gap-1 ${activeTab === 'settings' ? 'text-pink-600' : 'text-gray-400'}`}
                        >
                            <i data-lucide="pie-chart" className="w-6 h-6"></i>
                            <span className="text-[10px]">統計</span>
                        </button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>